<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragment/layout}">
<body>
<th:block layout:fragment="css">
  <link rel="stylesheet" href="/css/reservation.css">
  <script src="/js/index.global.6.1.17.min.js"></script>
  <style>
    .fc .fc-toolbar.fc-header-toolbar {margin-bottom:7px;}
    .fc .fc-toolbar-title {font-size:1.65em; color:#7768ae;}
    .fc .fc-button {padding:0.2em 0.5em;}
    .fc .fc-button-primary {background:#fff;}
    .fc .fc-button-primary:hover {background:#ccc;}
    .fc .fc-today-button {background:#2C3E50;}
    .fc .fc-button-primary:focus {box-shadow: none;}
    .fc-toolbar-chunk:nth-child(2) {margin-left:-150px;}
    .fc-h-event {border:none; background:#b1deff; cursor:pointer;}
    .fc-h-event * {font-size:13px;}
    .disabled-event {cursor:not-allowed!important; opacity:0.9; background:#ededed; pointer-events:auto;}
    .fc .fc-daygrid-day-events {display:flex; flex-wrap:wrap;}
    .fc .fc-daygrid-event-harness {flex:1 1 50%; max-width:50%;}
    .fc .fc-daygrid-event-harness.all-blocked {flex:1 1 100%; max-width:100%;}
  </style>
</th:block>
<section layout:fragment="content" id="container" class="reservation list">
    <h1>ìƒë‹´ì˜ˆì•½</h1>
    <div id="content" class="content">

      <section class="process_section">
        <div class="process_steps">
          <div class="step">
            <div class="icon">1</div>
            <p class="step_title">ìƒë‹´ì‹ ì²­</p>
          </div>
          <i class="xi-angle-right arrow"></i>
          <div class="step">
            <div class="icon">2</div>
            <p class="step_title">1ì°¨ ì „í™”ìƒë‹´</p>
          </div>
          <i class="xi-angle-right arrow"></i>
          <div class="step">
            <div class="icon">3</div>
            <p class="step_title">2ì°¨ ë°©ë¬¸ìƒë‹´</p>
          </div>
          <i class="xi-angle-right arrow"></i>
          <div class="step">
            <div class="icon">4</div>
            <p class="step_title">ê²°ì œ ë° í™•ì •</p>
          </div>
          <i class="xi-angle-right arrow"></i>
          <div class="step">
            <div class="icon">5</div>
            <p class="step_title">í–‰ì‚¬ì§„í–‰</p>
          </div>
        </div>

        <div class="process_guide">
          <dl>
            <dt>1. ìƒë‹´ì‹ ì²­</dt>
            <dd>í™ˆí˜ì´ì§€ë¥¼ í†µí•´ ìƒë‹´ ì‹ ì²­ì„œë¥¼ ì‘ì„±í•´ ì£¼ì„¸ìš”.</dd>
          </dl>
          <dl>
            <dt>2. 1ì°¨ ì „í™”ìƒë‹´</dt>
            <dd>ë‹´ë‹¹ í”Œë˜ë„ˆê°€ ì „í™” ë˜ëŠ” ì´ë©”ì¼ë¡œ ì—°ë½ë“œë¦½ë‹ˆë‹¤.</dd>
          </dl>
          <dl>
            <dt>3. 2ì°¨ ë°©ë¬¸ìƒë‹´</dt>
            <dd>ì§ì ‘ ë°©ë¬¸í•˜ì—¬ ì˜ˆì‹ ë˜ëŠ” í–‰ì‚¬ì— ëŒ€í•œ êµ¬ì²´ì ì¸ ìƒë‹´ì„ ì§„í–‰í•©ë‹ˆë‹¤.</dd>
          </dl>
          <dl>
            <dt>4. ê²°ì œ ë° í™•ì •</dt>
            <dd>ìƒë‹´ ë‚´ìš©ì— ë™ì˜í•˜ì‹œë©´ ê²°ì œë¥¼ í†µí•´ ì˜ˆì•½ì„ í™•ì •í•©ë‹ˆë‹¤.</dd>
          </dl>
          <dl>
            <dt>5. í–‰ì‚¬ì§„í–‰</dt>
            <dd>ì˜ˆì •ëœ ë‚ ì§œì— ë§ì¶° ì•„ë¦„ë‹¤ìš´ ì˜ˆì‹ ë° í–‰ì‚¬ì„ ì§„í–‰í•©ë‹ˆë‹¤.</dd>
          </dl>
        </div>
      </section>
      <h2 style="font-size:1.85em">ì˜ˆì•½ê°€ëŠ¥í•œ ë‚  ì„ íƒ</h2>
      <section class="calender mt15">
        <div id="calendar"></div>
        <!-- ì˜ˆì•½ë¶ˆê°€ ì‹œê°„ëŒ€ ì •ë³´ (JS Mapì— ì €ì¥) -->
        <script th:inline="javascript">
          const blockedMap = new Map();
          /*[# th:each="b : ${blocks}"]*/
            blockedMap.set(
              [[${#dates.format(b.eventDate, 'yyyy-MM-dd') + '_' + b.timeSlot}]],
              [[${b.reason != null ? b.reason : 'ë¶ˆê°€'}]]
            );
          /*[/]*/
        </script>
        <script>
          document.addEventListener('DOMContentLoaded', function () {
            const calendarEl = document.getElementById('calendar');

            const calendar = new FullCalendar.Calendar(calendarEl, {
              height: 'auto',
              initialView: 'dayGridMonth',
              locale: 'ko',
              selectable: true,
              events: generateWeekendEvents(), // ì´ë²¤íŠ¸ ë°°ì—´ ì§ì ‘ ì„¤ì •
              dayCellContent: info => info.date.getDate(),
              eventDidMount: function(info) {
                const { tooltip, reason } = info.event.extendedProps;

                if (reason) info.event.setProp("title", `${reason}`);
                if (tooltip) info.el.setAttribute('title', tooltip);

                // ALL ì°¨ë‹¨ì¼ ê²½ìš°, ë¶€ëª¨ ìš”ì†Œì— all-blocked í´ë˜ìŠ¤ ì¶”ê°€
                if (tooltip === 'ALL') {
                  setTimeout(() => {
                    const harness = info.el.closest('.fc-daygrid-event-harness');
                    if (harness && !harness.classList.contains('all-blocked')) {
                      harness.classList.add('all-blocked');
                      console.log('ğŸ‘€ ALL ë¶€ëª¨ í´ë˜ìŠ¤ ì ìš©:', harness);
                    }
                  }, 0);
                }


                if (info.event.classNames.includes('disabled-event')) {
                  info.el.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                  });
                }
              }
            });

            calendar.render();

            // ì£¼ë§(í† /ì¼) ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ëŒ€ ìƒì„±
            function generateWeekendEvents() {
              const today = new Date();
              const events = [];
              const existingEventKeys = new Set();
              const year = today.getFullYear();
              const month = today.getMonth();
              const nextMonth = new Date(year, month + 2, 0);
              let current = new Date(year, month, 1);

              while (current <= nextMonth) {
                const ymd = current.toISOString().slice(0, 10);
                const isPast = current < new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const day = current.getDay();
                const isTooSoon = (current - today) / (1000 * 60 * 60 * 24) < 14;

                if (day === 0 || day === 1) {
                  const allKey = `${ymd}_ALL`;
                  const isAllBlocked = blockedMap.has(allKey);

                  ['10ì‹œ', '12ì‹œ', '14ì‹œ', '16ì‹œ'].forEach(time => {
                    // ALL ì°¨ë‹¨ëœ ë‚ ì€ 10ì‹œì—ë§Œ í•˜ë‚˜ í‘œì‹œ
                    if (isAllBlocked) {
                      if (time !== '10ì‹œ') return;
                      const reason = blockedMap.get(allKey);
                      events.push({
                        title: reason,
                        date: ymd,
                        url: null,
                        classNames: ['disabled-event'],
                        extendedProps: {
                          tooltip: 'ALL',
                          reason: reason
                        }
                      });
                      //console.log("ALL ì°¨ë‹¨ ì²˜ë¦¬ë¨:", ymd, reason); // ë””ë²„ê¹…ìš©
                      return;
                    }

                    // ê°œë³„ ì‹œê°„ ì°¨ë‹¨ ì²˜ë¦¬
                    const key = `${ymd}_${time}`;
                    const rawReason = blockedMap.get(key);
                    const isBlocked = rawReason != null && rawReason.trim() !== '';
                    const reason = isBlocked ? rawReason : null;
                    const isDisabled = isPast || isTooSoon || isBlocked;

                    events.push({
                      title: isDisabled ? (isBlocked ? reason : 'ë¶ˆê°€') : 'ê°€ëŠ¥',
                      date: ymd,
                      url: isDisabled ? null : `/reservation/form?date=${ymd}&time=${time}`,
                      classNames: isDisabled ? ['disabled-event'] : ['available-event'],
                      extendedProps: {
                        tooltip: time,
                        reason: reason
                      }
                    });

                    existingEventKeys.add(key);
                  });
                }

                current.setDate(current.getDate() + 1);
              }

              return events;
            }

          });
        </script>
      </section>
      <p style="margin-top:10px; color:#c00; font-size:14px;">
        â€» í–‰ì‚¬ ì˜ˆì •ì¼ì€ ì˜¤ëŠ˜ë¡œë¶€í„° ìµœì†Œ 2ì£¼ ì´í›„ë§Œ ì˜ˆì•½ ê°€ëŠ¥í•©ë‹ˆë‹¤.
      </p>

    </div><!--E content-->
</section><!--E container-->
</body>
</html>
